angular.module("app.admin",["angles"]).controller("adminCtrl",function($scope,Page,Auth,API,Selection,$interval){Page.setTitleNav("Verwaltung | Crucio","Admin"),$scope.user=Auth.user(),$scope.tab_active="users",$scope.user_search={semester:"",group:"",login:"",query:"",query_keys:["group_name","username"]},$scope.comment_search={question_id:"",username:"",query:"",query_keys:["question","comment","username","question_id"]},$scope.update_activity=!1,$scope.show_activity={search_query:!1,result:!1,login:!1,register:!1,comment:!1,exam_new:!1,exam_update:!1},$scope.$watch("comment_search",function(newValue,oldValue){$scope.questions_by_comment_display=[],$scope.questions_by_comment&&$scope.questions_by_comment.forEach(function(comments){for(var i=0;i<comments.length;i++){var comment=comments[i];if(Selection.is_element_included(comment,newValue)){for(var found_idx=-1,j=0;j<$scope.questions_by_comment_display.length;j++)if($scope.questions_by_comment_display[j][0].question==comment.question){found_idx=j;break}found_idx>-1?$scope.questions_by_comment_display[found_idx].push(comment):$scope.questions_by_comment_display.push([comment])}}}),$scope.questions_by_comment_display.sort(function(a,b){return b[0].date-a[0].date})},!0),API.get("/users",function(data){$scope.users=data.users,$scope.distinct_semesters=Selection.find_distinct($scope.users,"semester"),$scope.distinct_semesters.sort(function(a,b){return a-b}),$scope.distinct_groups=["Standard","Admin","Autor"]}),API.get("/comments",function(data){$scope.comments=data.comments,$scope.distinct_questions=Selection.find_distinct($scope.comments,"question_id"),$scope.distinct_users=Selection.find_distinct($scope.comments,"username"),$scope.questions_by_comment=[],$scope.comments.forEach(function(c){for(var found=-1,i=0;i<$scope.questions_by_comment.length;i++)if($scope.questions_by_comment[i][0].question==c.question){found=i;break}found>-1?$scope.questions_by_comment[found].push(c):$scope.questions_by_comment.push([c])}),$scope.questions_by_comment_display=$scope.questions_by_comment}),API.get("/whitelist",function(data){$scope.whitelist=data.whitelist}),API.get("/stats/general",function(data){$scope.stats=data.stats}),$scope.add_mail=function(){var email=$scope.new_whitelist_mail;if(email.length){$scope.whitelist.push({username:"",mail_address:email});var post_data={mail_address:email.replace("@","(@)")};API.post("/whitelist",post_data,function(data){})}},$scope.remove_mail=function(index){var email=$scope.whitelist[index].mail_address;email.length&&($scope.whitelist.splice(index,1),API["delete"]("/whitelist/"+email,function(data){}))},$scope.send_mail=function(){var mailAddresses="";$("#user-table tbody tr:visible").children("td").children("a").each(function(i,obj){mailAddresses+=$(obj).attr("data-original-title")+","}),mailAddresses=mailAddresses.slice(0,-1),$window.location.href="mailto:"+mailAddresses},$scope.is_today=function(date){var today=new Date,date_c=new Date(1e3*date);return today.toDateString()==date_c.toDateString()?!0:!1},$scope.is_yesterday=function(date){var today=new Date,diff=today-864e5,yesterday=new Date(diff),date_c=new Date(1e3*date);return yesterday.toDateString()==date_c.toDateString()?!0:!1},$scope.user_in_selection=function(index){return Selection.is_element_included($scope.users[index],$scope.user_search)},$scope.user_in_selection_count=function(){return Selection.count($scope.users,$scope.user_search)},$scope.comment_in_selection_count=function(){return Selection.count($scope.comments,$scope.comment_search)},$scope.change_all_semester=function(number){var post_data={number:number};API.post("/admin/change-semester/dFt(45i$hBmk*I",post_data,function(data){alert(data.status)})},$scope.remove_test_account=function(index){API["delete"]("/users/test-account",function(data){alert(data.status)})}}).controller("liveStatisticsCtrl",function($scope,Page,Auth,API,$interval){function reloadData(){API.get("/stats/general",function(data){$scope.stats=data.stats,first&&($scope.chart_users=[{value:parseInt($scope.stats.user_count_semester[0]),color:"#e74c3c",label:"1. Semester"},{value:parseInt($scope.stats.user_count_semester[1]),color:"#e67e22",label:"2. Semester"},{value:parseInt($scope.stats.user_count_semester[2]),color:"#f1c40f",label:"3. Semester"},{value:parseInt($scope.stats.user_count_semester[3]),color:"#2ecc71",label:"4. Semester"},{value:parseInt($scope.stats.user_count_semester[4]),color:"#1abc9c",label:"5. Semester"},{value:parseInt($scope.stats.user_count_semester[5]),color:"#3498db",label:"6. Semester"},{value:parseInt($scope.stats.user_count_semester[6]),color:"#34495e",label:">6. Semester"}],$scope.chart_exams=[{value:parseInt($scope.stats.exam_count_semester[0]),color:"#e74c3c",label:"1. Semester"},{value:parseInt($scope.stats.exam_count_semester[1]),color:"#e67e22",label:"2. Semester"},{value:parseInt($scope.stats.exam_count_semester[2]),color:"#f1c40f",label:"3. Semester"},{value:parseInt($scope.stats.exam_count_semester[3]),color:"#2ecc71",label:"4. Semester"},{value:parseInt($scope.stats.exam_count_semester[4]),color:"#1abc9c",label:"5. Semester"},{value:parseInt($scope.stats.exam_count_semester[5]),color:"#3498db",label:"6. Semester"},{value:parseInt($scope.stats.exam_count_semester[6]),color:"#34495e",label:">6. Semester"}],$scope.chart_questions={labels:["Gesamt","Sichtbar","Mit Lösung","Mit Erklärung","Mit Kategorie","Freie Frage"],datasets:[{data:[$scope.stats.question_count,$scope.stats.visible_question_count,$scope.stats.question_count-$scope.stats.question_without_answer_count,$scope.stats.question_explanation_count,$scope.stats.question_topic_count,$scope.stats.question_free_count]}]},$scope.chart_time_result_today={labels:$scope.stats.result_dep_time_today_label,datasets:[{label:"My Second dataset",fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:$scope.stats.result_dep_time_today}]},first=!1)}),API.get("/stats/search-queries",function(data){$scope.search_queries=data.search_queries}),API.post("/stats/activities",$scope.show_activity,function(data){$scope.activities=data.activities})}Page.setTitleNav("Live Statistik | Crucio","Admin"),$scope.user=Auth.user(),$scope.tab_active="live-statistic",$scope.update_activity=!1,$scope.show_activity={search_query:!1,result:!1,login:!1,register:!1,comment:!1,exam_new:!1,exam_update:!1};var first=!0;reloadData();$interval(function(){$scope.update_activity&&reloadData()},2400)}).controller("qualityCtrl",function($scope,Page,Auth,API){Page.setTitleNav("Verwaltung | Crucio","Admin"),$scope.user=Auth.user(),$scope.tab_active="format",API.get("/quality",function(data){$scope.format=data.format,$scope.wrong=data.wrong})}).directive("crGroup",function(API){return{restrict:"E",scope:{user:"="},controller:function($scope,API){$scope.change_group=function(){var user_id=$scope.user.user_id,group_id=$scope.user.group_id,group_name_array=["Standard","Admin","Autor"];1==group_id?group_id=3:2==group_id||3==group_id&&(group_id=1),$scope.user.group_id=group_id,$scope.user.group_name=group_name_array[group_id-1];var post_data={group_id:group_id};API.put("/users/"+user_id+"/group",post_data,function(data){})}},templateUrl:"public/html/cr-group.html",transclude:!0}}).directive("timeago",function(){var strings={prefixAgo:"vor",prefixFromNow:"in",suffixAgo:"",suffixFromNow:"",seconds:"wenigen Sekunden",seconds_2:"einigen Sekunden",minute_2:"unter einer Minute",minute:"etwa einer Minute",minute_3:"über einer Minute",minutes:"%d Minuten",hour:"etwa einer Stunde",hours:"%d Stunden",day:"etwa einem Tag",days:"%d Tagen",month:"etwa einem Monat",months:"%d Monaten",year:"etwa einem Jahr",years:"%d Jahren",wordSeparator:" ",numbers:[]};return{restrict:"A",link:function(scope,element,attrs){attrs.$observe("timeago",function(){function is_function(functionToCheck){var getType={};return functionToCheck&&"[object Function]"===getType.toString.call(functionToCheck)}function substitute(stringOrFunction,number){var string=is_function(stringOrFunction)?stringOrFunction(number,distance_millis):stringOrFunction,value=strings.numbers&&strings.numbers[number]||number;return string.replace(/%d/i,value)}var given=parseInt(attrs.timeago),current=(new Date).getTime(),distance_millis=Math.abs(current-given),seconds=distance_millis/1e3,minutes=seconds/60,hours=minutes/60,days=hours/24,years=days/365,prefix=strings.prefixAgo,suffix=strings.suffixAgo,words=10>seconds&&substitute(strings.seconds,Math.round(seconds))||30>seconds&&substitute(strings.seconds_2,Math.round(seconds))||50>seconds&&substitute(strings.minute_2,1)||70>seconds&&substitute(strings.minute,1)||90>seconds&&substitute(strings.minute_3,1)||55>minutes&&substitute(strings.minutes,Math.round(minutes))||90>minutes&&substitute(strings.hour,1)||24>hours&&substitute(strings.hours,Math.round(hours))||42>hours&&substitute(strings.day,1)||30>days&&substitute(strings.days,Math.round(days))||45>days&&substitute(strings.month,1)||365>days&&substitute(strings.months,Math.round(days/30))||1.5>years&&substitute(strings.year,1)||substitute(strings.years,Math.round(years)),separator=strings.wordSeparator;String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};var result=[prefix,words,suffix].join(separator).trim();element.text(result)})}}}),angular.module("app.author",["angularFileUpload","textAngular"]).controller("authorCtrl",function($scope,Page,Auth,API,Selection,$location){Page.setTitleNav("Autor | Crucio","Autor"),$scope.user=Auth.user(),$scope.exam_search={subject:"",semester:"",author:$scope.user.username,query:"",query_keys:["subject","author","date"]},$scope.comment_search={username_added:"",username:"",query:"",query_keys:["question","comment","username","question_id"]},$scope.tab_active="exams",$scope.$watch("comment_search",function(newValue){$scope.questions_by_comment_display=[],$scope.questions_by_comment.forEach(function(comments){for(var i=0;i<comments.length;i++){var comment=comments[i];if(Selection.is_element_included(comment,newValue)){for(var found_idx=-1,j=0;j<$scope.questions_by_comment_display.length;j++)if($scope.questions_by_comment_display[j][0].question==comment.question){found_idx=j;break}found_idx>-1?$scope.questions_by_comment_display[found_idx].push(comment):$scope.questions_by_comment_display.push([comment])}}}),$scope.questions_by_comment_display.sort(function(a,b){return b[0].date-a[0].date})},!0),API.get("/exams/all-visibility",function(data){$scope.exams=data.exams,$scope.distinct_semesters=[],$scope.exams.forEach(function(entry){-1==$scope.distinct_semesters.indexOf(entry.semester)&&$scope.distinct_semesters.push(entry.semester)}),$scope.distinct_semesters.sort(),$scope.distinct_subjects=[],$scope.exams.forEach(function(entry){-1==$scope.distinct_subjects.indexOf(entry.subject)&&$scope.distinct_subjects.push(entry.subject)}),$scope.distinct_subjects.sort(),$scope.distinct_authors=[],$scope.exams.forEach(function(entry){-1==$scope.distinct_authors.indexOf(entry.author)&&$scope.distinct_authors.push(entry.author)}),$scope.distinct_authors.sort(),$scope.ready=1}),API.get("/comments/author/"+$scope.user.user_id,function(data){$scope.comments=data.comments,$scope.distinct_users=[],$scope.distinct_users_added=[],$scope.distinct_users=Selection.find_distinct($scope.comments,"username"),$scope.distinct_users_added=Selection.find_distinct($scope.comments,"username_added"),$scope.questions_by_comment=[],$scope.comments.forEach(function(c){for(var found=-1,i=0;i<$scope.questions_by_comment.length;i++)if($scope.questions_by_comment[i][0].question==c.question){found=i;break}found>0?$scope.questions_by_comment[found].push(c):$scope.questions_by_comment.push([c])}),$scope.questions_by_comment.sort(function(a,b){return b[0].date-a[0].date}),$scope.questions_by_comment_display=$scope.questions_by_comment,$scope.comment_search.username_added=$scope.user.username}),API.get("/subjects/categories",function(data){$scope.subject_list={},data.subjects.forEach(function(subject){$scope.subject_list[subject.name]=[]}),data.categories.forEach(function(category){$scope.subject_list[category.subject_name].push(category.name)})}),$scope.new_exam=function(){var post_data={subject:"",professor:"",semester:"",date:"",type:"",user_id_added:$scope.user.user_id,duration:"",notes:""};API.post("/exams",post_data,function(data){$location.path("/edit-exam").search("id",data.exam_id)})},$scope.comment_in_selection=function(index){return Selection.is_element_included($scope.comments[index],$scope.comment_search)},$scope.comment_in_selection_count=function(){return Selection.count($scope.comments,$scope.comment_search)},$scope.exam_in_selection=function(index){return Selection.is_element_included($scope.exams[index],$scope.exam_search)},$scope.exam_in_selection_count=function(){return Selection.count($scope.exams,$scope.exam_search)}}).controller("editCtrl",function($scope,$stateParams,Page,Auth,API,$location,FileUploader,$modal){function remake_uploader_array(){$scope.uploader_array=new Array;for(var i=0;i<$scope.exam.questions.length;i++){{var uploader=new FileUploader({url:"/public/php/upload-file.php",formData:i});$scope.exam.questions[i]}uploader.onSuccessItem=function(fileItem,response){var j=fileItem.formData;$scope.exam.questions[j].question_image_url=response.upload_name},$scope.uploader_array.push(uploader)}}function resize_overscroll(){var sidebar_height=$(this).height()-300+$footer.height();sidebar_height>$content_2.height()&&(sidebar_height=$content_2.height()),$sidebar.height(sidebar_height)}Page.setTitleNav("Klausur | Crucio","Autor"),$scope.user=Auth.user(),$scope.ready=0,$scope.exam_id=$stateParams.id,$scope.open_question_id=$stateParams.question_id,$scope.has_changed=0,$scope.number_changed=0,$scope.is_saving=0,$scope.uploader=new FileUploader({url:"/public/php/upload-file.php"}),$scope.uploader.onSuccessItem=function(fileItem,response,status,headers){$scope.exam.file_name=response.upload_name},$scope.uploader_array=[];{var $footer=$("#footer"),$sidebar=$(".edit-exam-wrapper"),$content_2=$(".edit-exam-wrapper .exam-edit-list-group");$scope.$watch("exam",function(newValue,oldValue){$scope.number_changed>1&&($scope.has_changed=1),$scope.number_changed+=1},!0)}$("body").on("shown.bs.tab",'a[data-toggle="tab"]',function(e){var previous=$(this).closest(".list-group").children(".active");previous.removeClass("active"),$(e.target).addClass("active")}),$scope.$on("$locationChangeStart",function(event,next,current){if(1==$scope.has_changed){var confirmClose=confirm("Die Änderungen an deiner Klausur bleiben dann ungespeichert. Wirklich verlassen?");confirmClose||event.preventDefault()}}),$(window).on("resize",function(){resize_overscroll()}),API.get("/exams/"+$scope.exam_id,function(data){$scope.exam=data,$scope.exam.semester=parseInt(data.semester),$scope.exam.duration=parseInt(data.duration);for(var i=0;i<$scope.exam.questions.length;i++)0==$scope.exam.questions[i].topic.length&&($scope.exam.questions[i].topic="Sonstiges");remake_uploader_array(),0==$scope.exam.questions.length&&$scope.add_question(0,!1),$scope.exam.subject||($scope.exam.subject="Allgemeine Pathologie",$scope.exam.sort="Erstklausur"),$scope.open_question_id,$scope.ready=1,setTimeout(function(){resize_overscroll()},10)}),API.get("/subjects/categories",function(data){$scope.subject_list={},data.subjects.forEach(function(subject){$scope.subject_list[subject.name]=[]}),data.categories.forEach(function(category){$scope.subject_list[category.subject_name].push(category.name)})}),$scope.add_question=function(show,scroll_to_question){"undefined"==typeof scroll_to_question&&(scroll_to_question=!0);var question={};if(question.question="",question.type=5,question.correct_answer=0,question.answers=new Array("","","","","",""),question.topic="Sonstiges",$scope.exam.questions.push(question),$scope.open_question_id=0,remake_uploader_array(),setTimeout(function(){resize_overscroll()},10),scroll_to_question){var new_show=$scope.exam.questions.length+1;setTimeout(function(){$(".edit-exam-wrapper a:nth-child("+new_show+")").tab("show")},10)}},$scope.delete_question=function(index){var question_id=$scope.exam.questions[index].question_id;question_id&&API["delete"]("/questions/"+question_id,function(data){}),$scope.exam.questions.splice(index,1),remake_uploader_array();var new_show=index+1;setTimeout(function(){$(".edit-exam-wrapper a:nth-child("+new_show+")").tab("show")},10),0==$scope.exam.questions.length&&$scope.add_question(1),setTimeout(function(){resize_overscroll()},10)},$scope.leave_edit=function(){$scope.$apply($location.path($scope.next_route))},$scope.save_exam=function(){var validate=!0;if($scope.exam.subject||(validate=!1),$scope.exam.semester<1&&(validate=!1),$scope.exam.date||(validate=!1),validate){$scope.is_saving=1;var post_data=$scope.exam;API.put("/exams/"+$scope.exam_id,post_data,function(data){}),$scope.exam.questions.forEach(function(question){var validate_question=!0;if(question.question.length||(validate_question=!1),question.question_id&&(validate_question=!0),validate_question){question.explanation||(question.explanation=""),question.question_image_url||(question.question_image_url="");var post_question_data={question:question.question,topic:question.topic,type:question.type,answers:question.answers,correct_answer:question.correct_answer,exam_id:$scope.exam.exam_id,user_id_added:$scope.user.user_id,explanation:question.explanation,question_image_url:question.question_image_url};question.question_id?API.put("/questions/"+question.question_id,post_question_data,function(data){}):API.post("/questions",post_question_data,function(data){question.question_id=data.question_id})}}),$scope.has_changed=0,$scope.is_saving=0}else alert("Es fehlen noch allgemeine Infos zur Klausur.")},$scope.open_delete_exam_model=function(){$modal.open({templateUrl:"delete-exam-modal.html",controller:function($scope,$modalInstance,exam_id){$scope.delete_exam=function(){API["delete"]("/exams/"+exam_id,function(data){$modalInstance.close(),$location.url("/author")})}},resolve:{exam_id:function(){return $scope.exam.exam_id}}})}}).filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!=lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" ?")}});var app=angular.module("app",["ui.router","ngSanitize","angular-loading-bar","ui.bootstrap","app.crucio","app.user","app.learn","app.author","app.admin"]);app.config(function($stateProvider,$urlRouterProvider,$locationProvider){$stateProvider.state("learn",{url:"/learn",templateUrl:"views/learn.html",controller:"learnCtrl"}).state("question",{url:"/question?id",templateUrl:"views/question.html",controller:"questionCtrl"}).state("exam",{url:"/exam?id",templateUrl:"views/exam.html",controller:"examCtrl"}).state("analysis",{url:"/analysis",templateUrl:"views/analysis.html",controller:"analysisCtrl"}).state("statistics",{url:"/statistics",templateUrl:"views/statistics.html",controller:"statisticsCtrl"}).state("account",{url:"/account",templateUrl:"views/account.html",controller:"accountCtrl"}).state("settings",{url:"/settings",templateUrl:"views/settings.html",controller:"settingsCtrl"}).state("author",{url:"/author",templateUrl:"views/author.html",controller:"authorCtrl"}).state("edit-exam",{url:"/edit-exam?id",templateUrl:"views/edit-exam.html",controller:"editCtrl"}).state("admin",{url:"/admin",templateUrl:"views/admin.html",controller:"adminCtrl"}).state("live-statistics",{url:"/live-statistics",templateUrl:"views/live-statistics.html",controller:"liveStatisticsCtrl"}).state("quality",{url:"/quality",templateUrl:"views/quality.html",controller:"qualityCtrl"}).state("403",{url:"/403",templateUrl:"views/403.html",controller:"errorCtrl"}).state("404",{url:"/404",templateUrl:"views/404.html",controller:"errorCtrl"}).state("500",{url:"/500",templateUrl:"views/500.html",controller:"errorCtrl"}),$locationProvider.html5Mode(!0)}),app.run(function($location,Auth){var routesForAuthor=["/author","/edit-exam"],routesForAdmin=["/admin"],routeInArray=function(route,array){var route_c=route;return route.indexOf("?")>-1&&(route_c=route.substr(0,route.indexOf("?"))),array.indexOf(route_c)>-1?!0:!1},user=Auth.user(),isLoggedIn=!1,isAuthor=!1,isAdmin=!1;user&&(user.group_id&&(isLoggedIn=!0),3==user.group_id&&(isAuthor=!0),2==user.group_id&&(isAdmin=!0));var route=$location.url();!routeInArray(route,routesForAuthor)||isAuthor||isAdmin||$location.path("/403"),routeInArray(route,routesForAdmin)&&!isAdmin&&$location.path("/403")}),app.factory("Page",function(){var title="Crucio",nav="";return{title:function(){return title},setTitle:function(newTitle){title=newTitle},nav:function(){return nav},setNav:function(newNav){nav=newNav},setTitleNav:function(newTitle,newNav){title=newTitle,nav=newNav}}}),app.factory("Auth",function($window){var user;return{user:function(){return angular.isDefined(user)||(angular.isDefined(sessionStorage.user)?user=angular.fromJson(sessionStorage.user):angular.isDefined(localStorage.user)?(sessionStorage.user=localStorage.user,user=angular.fromJson(localStorage.user)):$window.location.replace($window.location.origin)),user},logout:function(){sessionStorage.removeItem("user"),localStorage.removeItem("user"),$window.location.replace($window.location.origin)},setUser:function(newUser){angular.isDefined(sessionStorage.user)&&(sessionStorage.user=angular.toJson(newUser)),angular.isDefined(localStorage.user)&&(localStorage.user=angular.toJson(newUser))}}}),app.factory("API",function($http,$location){var apiBase="api/v1";return{get:function(path,successFunction){$http.get(apiBase+path).success(function(data,status){200==status?successFunction(data):500==status&&$location.path("/500")})},post:function(path,post_data,successFunction){$http.post(apiBase+path,post_data).success(function(data,status){200==status?successFunction(data):500==status&&$location.path("/500")})},put:function(path,post_data,successFunction){$http.put(apiBase+path,post_data).success(function(data,status){200==status?successFunction(data):500==status&&$location.path("/500")})},"delete":function(path,successFunction){$http["delete"](apiBase+path,{}).success(function(data,status){200==status?successFunction(data):500==status&&$location.path("/500")})}}}),app.directive("crSelect",function(){return{restrict:"E",scope:{model:"=",suffix:"=",all:"=",data:"="},templateUrl:"public/html/cr-select.html",replace:!0}}),app.service("Selection",function(){this.is_element_included=function(element,search_dictionary){for(var key in search_dictionary)if("query"==key){var query_string="";search_dictionary.query_keys.forEach(function(query_key){query_string+=element[query_key]+" "});for(var substring_array=search_dictionary.query.toLowerCase().split(" "),i=0,len=substring_array.length;len>i;++i){var substring=substring_array[i];if(query_string.toLowerCase().indexOf(substring)<0&&substring)return!1}}else if("group"==key){if(search_dictionary.group!=element.group_name&&search_dictionary.group)return!1}else if("query_keys"!=key&&search_dictionary[key]!=element[key]&&search_dictionary[key])return!1;return!0},this.count=function(list,search_dictionary){if(!list)return 0;for(var counter=0,i=0;i<list.length;i++)this.is_element_included(list[i],search_dictionary)&&counter++;return counter},this.find_distinct=function(list,search_key){var result=[];return list.forEach(function(entry){-1==result.indexOf(entry[search_key])&&result.push(entry[search_key])}),result.sort(),result}}),angular.module("app.crucio",[]).controller("titleCtrl",function($scope,Page){$scope.title=function(){return Page.title()}}).controller("navCtrl",function($scope,Auth,Page){$scope.nav=function(){return Page.nav()},$scope.user=Auth.user(),$scope.logout=function(){Auth.logout()}}).controller("errorCtrl",function($scope,Page){Page.setTitleNav("Fehler | Crucio","")}),angular.module("app.learn",["ui.slider"]).controller("learnCtrl",function($scope,Page,Auth,API,Exam,$location,Selection){Page.setTitleNav("Lernen | Crucio","Lernen"),$scope.user=Auth.user(),$scope.tab_active="abstract",$scope.exam_search={subject:"",semester:"",query:"",query_keys:["subject","semester","date"]},$scope.comment_search={query:"",query_keys:["comment","username","question_id"]},$scope.tag_search={query:"",query_keys:["tag"]},$scope.question_field_message="",$scope.selection_subject_list={},$scope.selection_number_questions=0,$scope.number_questions_in_choosen_subjects=0,$scope.conditions=1;var spinner=new Spinner({length:0,radius:18,color:"#333",shadow:!1});$scope.slider={step:10,min:0,max:$scope.number_questions_in_choosen_subjects},$scope.$watch("selection_subject_list",function(newValue,oldValue){var post_data={ignoreLoadingBar:!0,selection_subject_list:$scope.selection_subject_list};API.post("/learn/number-questions",post_data,function(data){$scope.number_questions_in_choosen_subjects=data.number_questions,0==$scope.selection_number_questions&&($scope.selection_number_questions=Math.min($scope.number_questions_in_choosen_subjects,50)),$scope.selection_number_questions>$scope.number_questions_in_choosen_subjects&&($scope.selection_number_questions=$scope.number_questions_in_choosen_subjects)})},!0),$scope.$watch("number_questions_in_choosen_subjects",function(newValue,oldValue){var max=$scope.number_questions_in_choosen_subjects,max_number_questions=400;max>max_number_questions&&(max=max_number_questions);var step=20;400>max&&(step=20),200>max&&(step=10),40>max&&(step=2),20>max&&(step=1),max_number_questions>max&&max%step!=0&&(max+=step),$scope.slider={step:step,min:0,max:max}},!0),API.get("/exams/user_id/"+$scope.user.user_id,function(data){$scope.exams=data.exams,$scope.distinct_semesters=Selection.find_distinct($scope.exams,"semester"),$scope.distinct_subjects=Selection.find_distinct($scope.exams,"subject"),$scope.abstract_exams=[],$scope.exams.forEach(function(entry){var select=!0;entry.semester!=$scope.user.semester&&(select=!1),"unbekannt"==entry.date&&(select=!1),$scope.exams.length>10&&entry.question_count<30&&(select=!1),entry.answered_questions>0&&(select=!0),select&&(entry.answered_questions>0?$scope.abstract_exams.unshift(entry):$scope.abstract_exams.push(entry))}),$scope.ready=1}),API.get("/tags/"+$scope.user.user_id,function(data){$scope.tags=data.tags,$scope.distinct_tags=[],$scope.tags.forEach(function(entry){entry.tags.split(",").forEach(function(tagText){-1==$scope.distinct_tags.indexOf(tagText)&&$scope.distinct_tags.push(tagText)})}),$scope.questions_by_tag={},$scope.distinct_tags.forEach(function(distinct_tag){$scope.questions_by_tag[distinct_tag]=[]}),$scope.distinct_tags.forEach(function(distinct_tag){$scope.tags.forEach(function(entry){entry.tags.split(",").forEach(function(tagText){distinct_tag==tagText&&$scope.questions_by_tag[distinct_tag].push(entry)})})})}),API.get("/comments/"+$scope.user.user_id,function(data){$scope.comments=data.comments,$scope.questions_by_comment={},$scope.comments.forEach(function(c){$scope.questions_by_comment[c.question]=[]}),$scope.comments.forEach(function(c){$scope.questions_by_comment[c.question].push(c)})}),API.get("/subjects/categories",function(data){$scope.subject_list={},data.subjects.forEach(function(subject){$scope.subject_list[subject.name]=[]}),data.categories.forEach(function(category){$scope.subject_list[category.subject_name].push(category.name)})}),$scope.learn_exam=function(exam_id){var random=1;API.get("/exams/action/prepare/"+exam_id+"/"+random,function(data){var question_list={list:data.list,exam_id:exam_id};Exam.setCurrentQuestionList(question_list),$location.path("/question").search("id",question_list.list[0].question_id)})},$scope.learn_subjects=function(){var post_data={selection_subject_list:$scope.selection_subject_list,selection_number_questions:$scope.selection_number_questions};API.post("/learn/prepare",post_data,function(data){var question_list={list:data.list,selection_subject_list:selection_subject_list};Exam.setCurrentQuestionList(question_list),$location.path("/question").search("id",question_list.list[0].question_id)})},$scope.reset_results=function(index){var exam_id=$scope.exams[index].exam_id;$scope.exams[index].answered_questions=0,API["delete"]("/results/"+$scope.user.user_id+"/"+exam_id,function(data){})},$scope.reset_abstract_results=function(index){var exam_id=$scope.abstract_exams[index].exam_id;$scope.abstract_exams[index].answered_questions=0,API["delete"]("/results/"+$scope.user.user_id+"/"+exam_id,function(data){})},$scope.toggle_selection=function(subject,category,checked){var selection=$scope.selection_subject_list,subjects=$scope.subject_list;if(checked||(checked=!1),Object.keys(selection).indexOf(subject)>-1)if(0==selection[subject].length)"all"==category&&(selection[subject]=null);else if(selection[subject].length>0)if("all"==category)selection[subject]=checked?null:subjects[subject].slice(0);else{var idx=selection[subject].indexOf(category);idx>-1?(selection[subject].splice(idx,1),0==selection[subject].length&&(selection[subject]=null)):selection[subject].push(category)}else selection[subject]="all"==category?subjects[subject].slice(0):[category];else selection[subject]="all"==category?subjects[subject].slice(0):[category]},$scope.search_question=function(){$scope.search_results=[];var query_question=$scope.question_search_query;$scope.question_field_message="",query_question.length&&(spinner.spin(document.getElementById("spinner")),API.get("/questions/search/"+$scope.question_search_query+"/"+$scope.user.user_id,function(data){spinner.stop(),0==data.result.length?$scope.question_field_message="Nichts gefunden ;(":data.result.length>100?$scope.question_field_message="Zu Viel gefunden, geht es ein bisschen konkreter? ;(":$scope.search_results=data.result}))},$scope.exam_in_selection=function(index){return Selection.is_element_included($scope.exams[index],$scope.exam_search)},$scope.exam_in_selection_count=function(){return Selection.count($scope.exams,$scope.exam_search)},$scope.comment_in_selection=function(index){return Selection.is_element_included($scope.comments[index],$scope.comment_search)},$scope.comment_in_selection_count=function(){return Selection.count($scope.comments,$scope.comment_search)}}).controller("examCtrl",function($scope,$stateParams,Page,Auth,API,Exam,$location,$modal){Page.setTitleNav("Klausur | Crucio","Lernen"),$scope.user=Auth.user(),$scope.exam_id=$stateParams.id,$scope.question_list={exam_id:$scope.exam_id,list:[]},$scope.Math=window.Math,$scope.current_index=0,API.get("/exams/"+$scope.exam_id,function(data){$scope.exam=data;var questions=$scope.exam.questions;for(i=0;i<questions.length;i++){var q=questions[i];$scope.question_list.list[i]=q}}),$scope.save_answer=function(question_i,given_answer){$scope.question_list.list[question_i].given_result=String(given_answer)},$scope.hand_exam=function(){Exam.setCurrentQuestionList($scope.question_list),$location.path("/analysis").search("id",null)},$scope.open_image_model=function(file_name){$modal.open({templateUrl:"imageModalContent.html",controller:function($scope,image_url){$scope.image_url=image_url},resolve:{image_url:function(){return file_name}}})}}).controller("questionCtrl",function($scope,Page,Auth,API,$stateParams,Exam,$location,$modal,$window){Page.setTitleNav("Frage | Crucio","Lernen"),$scope.user=Auth.user(),Array.prototype.getIndexBy=function(name,value){for(var i=0;i<this.length;i++)if(this[i][name]==value)return i},$scope.answerButtonClass="btn-primary",$scope.question_list=Exam.currentQuestionList(),$scope.question_id=$stateParams.id,$scope.reset_session=$stateParams.reset_session,$scope.question_id||$window.location.replace("/learn"),$scope.show_explanation=0,$scope.given_result=0,$scope.strike={},$scope.reset_session&&($scope.question_list={},
Exam.setCurrentQuestionList($scope.question_list)),$scope.question_list&&Object.keys($scope.question_list).length&&($scope.index=$scope.question_list.list.getIndexBy("question_id",$scope.question_id),$scope.length=$scope.question_list.list.length,$scope.show_answer=$scope.question_list.list[$scope.index].mark_answer,$scope.given_result=$scope.question_list.list[$scope.index].given_result,$scope.question_list.list[$scope.index].strike&&($scope.strike=$scope.question_list.list[$scope.index].strike)),$scope.$watch("strike",function(newValue,oldValue){$scope.question_list&&Object.keys($scope.question_list).length&&($scope.question_list.list[$scope.index].strike=newValue,Exam.setCurrentQuestionList($scope.question_list))},!0),API.get("/questions/"+$scope.question_id+"/user/"+$scope.user.user_id,function(data){if($scope.question=data,$scope.question.question_image_url&&($scope.question.question_image_url="/public/files/"+$scope.question.question_image_url),$scope.question.comments)for(var i=0;i<$scope.question.comments.length;i++)$scope.question.comments[i].voting=parseInt($scope.question.comments[i].voting)||0,$scope.question.comments[i].user_voting=parseInt($scope.question.comments[i].user_voting)||0;var tags=[];$scope.question.tags&&(tags=$scope.question.tags.split(",")),$("#tagInput").tagsManager({prefilled:tags,maxTags:5,replace:!0,output:null,tagsContainer:null,tagCloseIcon:"&times;",tagClass:"tm-tag-danger",onlyTagList:!1,createHandler:function(tagManager,tags){var post_data={tags:tags,question_id:$scope.question_id,user_id:$scope.user.user_id};API.post("/tags",post_data,function(data){})},removeHandler:function(tagManager,tags){var post_data={tags:tags,question_id:$scope.question_id,user_id:$scope.user.user_id};API.post("/tags",post_data,function(data){})}}),$scope.given_result&&$scope.check_answer($scope.given_result),$scope.show_answer&&$scope.mark_answer($scope.given_result)}),$scope.show_solution=function(){var correct_answer=$scope.correct_answer(),correct=correct_answer==$scope.given_result?1:0;0==correct_answer&&(correct=-1),1==$scope.question.type&&(correct=-1);var post_data={correct:correct,question_id:$scope.question_id,user_id:$scope.user.user_id,given_result:$scope.given_result};API.post("/results",post_data,function(data){}),$scope.question_list&&Object.keys($scope.question_list).length&&($scope.question_list.list[$scope.index].mark_answer=1,Exam.setCurrentQuestionList($scope.question_list)),$scope.mark_answer($scope.given_result)},$scope.save_answer=function(given_answer){$scope.given_result=given_answer,$scope.question_list&&Object.keys($scope.question_list).length&&($scope.question_list.list[$scope.index].given_result=given_answer,Exam.setCurrentQuestionList($scope.question_list))},$scope.check_answer=function(answer){$scope.checked_answer=answer},$scope.correct_answer=function(){return $scope.question.correct_answer},$scope.mark_answer=function(given_answer){$scope.mark_answer_free=!0;var type=$scope.question.type,correct_answer=$scope.correct_answer();type>1?($scope.check_answer(given_answer),given_answer==correct_answer?($scope.correctAnswer=given_answer,$scope.answerButtonClass="btn-success"):($scope.wrongAnswer=given_answer,$scope.correctAnswer=correct_answer,$scope.answerButtonClass="btn-danger")):1==type&&($scope.answerButtonClass="btn-info")},$scope.add_comment=function(){var now=new Date/1e3,post_data={comment:$scope.comment_text,question_id:$scope.question_id,reply_to:0,username:$scope.user.username,date:now};API.post("/comments/"+$scope.user.user_id,post_data,function(data){post_data.voting=0,post_data.user_voting=0,post_data.comment_id=data.comment_id,$scope.question.comments.push(post_data),$scope.comment_text=""})},$scope.delete_comment=function(index){var comment_id=$scope.question.comments[index].comment_id;API["delete"]("/comments/"+comment_id,function(data){}),$scope.question.comments.splice(index,1)},$scope.open_image_model=function(){$modal.open({templateUrl:"imageModalContent.html",controller:function($scope,image_url){$scope.image_url=image_url},resolve:{image_url:function(){return $scope.question.question_image_url}}})}}).controller("analysisCtrl",function($scope,Page,Auth,API,Exam){Page.setTitleNav("Analyse | Crucio","Lernen"),$scope.user=Auth.user(),Array.prototype.getArrayByKey=function(name){for(var array=[],i=0;i<this.length;i++)this[i][name]&&array.push(this[i]);return array},$scope.question_list=Exam.currentQuestionList();for(var i=0;i<$scope.question_list.list.length;i++){var question=$scope.question_list.list[i];if(!question.mark_answer){if(question.type>1&&question.given_result>0){var correct=question.correct_answer==question.given_result?1:0;0==question.correct_answer&&(correct=-1);var post_data={correct:correct,question_id:question.question_id,user_id:$scope.user.user_id,given_answer:question.given_result};API.post("/results",post_data,function(data){})}question.mark_answer="analysis"}}$scope.workedquestion_list=$scope.question_list.list.getArrayByKey("given_result"),$scope.exam_id=$scope.question_list.exam_id,$scope.all_question_count=$scope.question_list.list.length,$scope.worked_question_count=$scope.workedquestion_list.length,$scope.correct_q_count=0,$scope.wrong_q_count=0,$scope.seen_q_count=0,$scope.solved_q_count=0,$scope.free_q_count=0,$scope.no_answer_q_count=0,$scope.get_random=function(min,max){if(min>max)return-1;if(min==max)return min;var r;do r=Math.random();while(1==r);return min+parseInt(r*(max-min+1))},$scope.random=$scope.get_random(0,1e3);for(var i=0;i<$scope.worked_question_count;i++){var question=$scope.workedquestion_list[i];question.correct_answer==question.given_result&&question.given_result>0&&question.correct_answer>0&&$scope.correct_q_count++,question.correct_answer!=question.given_result&&question.given_result>0&&question.correct_answer>0&&$scope.wrong_q_count++,question.given_result>0&&$scope.solved_q_count++,question.given_result>-2&&$scope.seen_q_count++,1==question.type&&$scope.free_q_count++,0==question.correct_answer&&1!=question.type&&$scope.no_answer_q_count++}$scope.exam_id&&API.get("/exams/"+$scope.exam_id,function(data){$scope.exam=data})}).controller("statisticsCtrl",function($scope,Page,Auth,API){Page.setTitleNav("Statistik | Crucio","Statistik"),$scope.user=Auth.user(),$scope.tab_active="general",API.get("/stats/user_id/"+$scope.user.user_id,function(data){$scope.stats=data.stats})}).factory("Exam",function(){return{currentQuestionList:function(){return angular.fromJson(localStorage.currentQuestionList)},setCurrentQuestionList:function(newQuestionList){localStorage.currentQuestionList=angular.toJson(newQuestionList)}}}).filter("newline_to_br",function($sce){return function(text){return void 0!==text?text.replace(/\n/g,"<br>"):void 0}}).directive("timeago",function(){var strings={prefixAgo:"vor",prefixFromNow:"in",suffixAgo:"",suffixFromNow:"",seconds:"wenigen Sekunden",minute:"etwa einer Minute",minutes:"%d Minuten",hour:"etwa einer Stunde",hours:"%d Stunden",day:"etwa einem Tag",days:"%d Tagen",month:"etwa einem Monat",months:"%d Monaten",year:"etwa einem Jahr",years:"%d Jahren",wordSeparator:" ",numbers:[]};return{restrict:"A",link:function(scope,element,attrs){attrs.$observe("timeago",function(){function is_function(functionToCheck){var getType={};return functionToCheck&&"[object Function]"===getType.toString.call(functionToCheck)}function substitute(stringOrFunction,number){var string=is_function(stringOrFunction)?stringOrFunction(number,distance_millis):stringOrFunction,value=strings.numbers&&strings.numbers[number]||number;return string.replace(/%d/i,value)}var given=parseInt(attrs.timeago),current=(new Date).getTime(),distance_millis=Math.abs(current-given),seconds=distance_millis/1e3,minutes=seconds/60,hours=minutes/60,days=hours/24,years=days/365,prefix=strings.prefixAgo,suffix=strings.suffixAgo,words=45>seconds&&substitute(strings.seconds,Math.round(seconds))||90>seconds&&substitute(strings.minute,1)||45>minutes&&substitute(strings.minutes,Math.round(minutes))||90>minutes&&substitute(strings.hour,1)||24>hours&&substitute(strings.hours,Math.round(hours))||42>hours&&substitute(strings.day,1)||30>days&&substitute(strings.days,Math.round(days))||45>days&&substitute(strings.month,1)||365>days&&substitute(strings.months,Math.round(days/30))||1.5>years&&substitute(strings.year,1)||substitute(strings.years,Math.round(years)),separator=strings.wordSeparator;String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};var result=[prefix,words,suffix].join(separator).trim();element.text(result)})}}}).directive("crCommentVote",function(API){return{restrict:"E",scope:{user:"=",comment:"="},controller:function($scope,API){$scope.increase_user_voting=function(){$scope.comment.user_voting=1==$scope.comment.user_voting?1:$scope.comment.user_voting+1;var post_data={user_voting:$scope.comment.user_voting};API.post("/comments/"+$scope.comment.comment_id+"/user/"+$scope.user.user_id,post_data,function(data){})},$scope.decrease_user_voting=function(){$scope.comment.user_voting=-1==$scope.comment.user_voting?-1:$scope.comment.user_voting-1;var post_data={user_voting:$scope.comment.user_voting};API.post("/comments/"+$scope.comment.comment_id+"/user/"+$scope.user.user_id,post_data,function(data){})}},templateUrl:"public/html/cr-comment-vote.html",transclude:!0}}),angular.module("app.user",["ui.slider"]).controller("accountCtrl",function($scope,Page,Auth,API,Validate){Page.setTitleNav("Account | Crucio","Name"),$scope.user=Auth.user(),$scope.user.semester=parseInt($scope.user.semester),$scope.Validate=Validate,$scope.old_password="",$scope.wrong_password=!1,$scope.submit_button_title="Speichern",$scope.$watch("user.email",function(new_value,old_value){new_value!=old_value&&($scope.submit_button_title="Speichern")},!0),$scope.$watch("old_password",function(new_value,old_value){new_value!=old_value&&($scope.submit_button_title="Speichern",$scope.wrong_password=!1)},!0),$scope.$watch("new_password",function(new_value,old_value){new_value!=old_value&&($scope.submit_button_title="Speichern")},!0),$scope.$watch("new_password_c",function(new_value,old_value){new_value!=old_value&&($scope.submit_button_title="Speichern")},!0),$scope.save_user=function(){var validation=!0;if(Validate.email($scope.user.email)||(validation=!1),(!$scope.user.semester||$scope.user.semester<=0)&&(validation=!1),$scope.old_password.length>0&&($scope.new_password.length<6&&(validation=!1),$scope.new_password!=$scope.new_password_c&&(validation=!1)),!validation)return $scope.submit_button_title="Speichern nicht möglich...",!1;$scope.submit_button_title="Speichern...";var post_data={email:$scope.user.email.replace("@","(@)"),course_id:$scope.user.course_id,semester:$scope.user.semester,current_password:$scope.old_password,password:$scope.new_password};API.put("/users/"+$scope.user.user_id+"/account",post_data,function(data){"success"==data.status?(Auth.setUser($scope.user),$scope.submit_button_title="Gespeichert"):($scope.user=Auth.user(),$scope.user.semester=parseInt($scope.user.semester),"error_incorrect_password"==data.status&&($scope.wrong_password=!0),$scope.submit_button_title="Speichern nicht möglich...")})}}).controller("settingsCtrl",function($scope,Page,Auth,API){Page.setTitleNav("Einstellungen | Crucio","Name"),$scope.user=Auth.user(),$scope.submit_button_title="Speichern",$scope.update_user=function(){$scope.submit_button_title="Speichern...";var post_data={highlightExams:$scope.user.highlightExams,showComments:$scope.user.showComments,repetitionValue:$scope.user.repetitionValue,useAnswers:$scope.user.useAnswers,useTags:$scope.user.useTags};API.put("/users/"+$scope.user.user_id+"/settings",post_data,function(data){"success"==data.status?(Auth.setUser($scope.user),$scope.submit_button_title="Gespeichert"):($scope.user=Auth.user(),$scope.submit_button_title="Speichern nicht möglich...")})},$scope.remove_all_results=function(){API["delete"]("/results/"+$scope.user.user_id,function(data){})}}).service("Validate",function(API){var whitelist=Array();API.get("/whitelist",function(data){whitelist=data.whitelist}),this.email=function(email){var regex=/[\wäüöÄÜÖ]*@studserv\.uni-leipzig\.de$/;if(0==whitelist.length)return!0;if(regex.test(email))return!0;for(var i=0;i<whitelist.length;i++)if(whitelist[i].mail_address==email)return!0;return!1},this.password=function(password){return password?password.length<6?!1:!0:!1},this.non_empty=function(text){return 0==text.length?!1:!0}});